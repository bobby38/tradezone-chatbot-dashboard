<!doctype html>
<html>
    <head>
        <title>LiveKit Voice Agent Test</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .container {
                background: white;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                max-width: 800px;
                width: 100%;
                overflow: hidden;
            }

            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                text-align: center;
            }

            .header h1 {
                font-size: 32px;
                margin-bottom: 10px;
            }

            .header p {
                opacity: 0.9;
                font-size: 16px;
            }

            .content {
                padding: 30px;
            }

            .status-card {
                background: #f8f9fa;
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 20px;
                border-left: 4px solid #667eea;
            }

            .status-card strong {
                display: block;
                margin-bottom: 8px;
                color: #333;
            }

            .status-text {
                font-size: 18px;
                color: #667eea;
                font-weight: 600;
            }

            .status-text.connected {
                color: #28a745;
            }

            .status-text.error {
                color: #dc3545;
            }

            .button-group {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
            }

            button {
                flex: 1;
                padding: 15px 30px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                border: none;
                border-radius: 12px;
                transition: all 0.3s ease;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            .btn-primary:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            }

            .btn-danger {
                background: #dc3545;
                color: white;
            }

            .btn-danger:hover:not(:disabled) {
                background: #c82333;
                transform: translateY(-2px);
            }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .transcript {
                background: #f8f9fa;
                border-radius: 12px;
                padding: 20px;
                min-height: 300px;
                max-height: 500px;
                overflow-y: auto;
            }

            .transcript::-webkit-scrollbar {
                width: 8px;
            }

            .transcript::-webkit-scrollbar-track {
                background: #e9ecef;
                border-radius: 4px;
            }

            .transcript::-webkit-scrollbar-thumb {
                background: #667eea;
                border-radius: 4px;
            }

            .message {
                margin-bottom: 15px;
                padding: 12px 16px;
                border-radius: 12px;
                animation: slideIn 0.3s ease;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .message.user {
                background: #e3f2fd;
                margin-left: 20%;
                border-bottom-right-radius: 4px;
            }

            .message.agent {
                background: #fff3cd;
                margin-right: 20%;
                border-bottom-left-radius: 4px;
            }

            .message.system {
                background: #e9ecef;
                text-align: center;
                font-style: italic;
                color: #6c757d;
            }

            .message strong {
                display: block;
                margin-bottom: 5px;
                font-size: 14px;
                opacity: 0.8;
            }

            .message-text {
                color: #333;
                line-height: 1.5;
            }

            .empty-state {
                text-align: center;
                color: #6c757d;
                font-style: italic;
                padding: 40px 20px;
            }

            .checklist {
                background: #f8f9fa;
                border-radius: 12px;
                padding: 20px;
                margin-top: 20px;
            }

            .checklist h3 {
                margin-bottom: 15px;
                color: #333;
            }

            .checklist-item {
                padding: 10px;
                margin-bottom: 8px;
                background: white;
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .checklist-item input[type="checkbox"] {
                width: 20px;
                height: 20px;
                cursor: pointer;
            }

            .checklist-item label {
                flex: 1;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üéôÔ∏è LiveKit Voice Agent Test</h1>
                <p>Test your TradeZone voice assistant powered by LiveKit</p>
            </div>

            <div class="content">
                <div class="status-card">
                    <strong>Connection Status:</strong>
                    <div class="status-text" id="statusText">Not connected</div>
                </div>

                <div class="button-group">
                    <button
                        id="connectBtn"
                        class="btn-primary"
                        onclick="connect()"
                    >
                        üé§ Connect & Start Call
                    </button>
                    <button
                        id="disconnectBtn"
                        class="btn-danger"
                        onclick="disconnect()"
                        disabled
                    >
                        ‚èπÔ∏è Disconnect
                    </button>
                </div>

                <div class="transcript" id="transcript">
                    <div class="empty-state">
                        Click "Connect & Start Call" to begin testing.<br />
                        The agent will join automatically and you can speak
                        naturally.
                    </div>
                </div>

                <div class="checklist">
                    <h3>‚úÖ Test Checklist</h3>
                    <div class="checklist-item">
                        <input type="checkbox" id="check1" />
                        <label for="check1">Voice connection works</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check2" />
                        <label for="check2"
                            >Say "Do you have PS5 games?" - searchProducts
                            tool</label
                        >
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check3" />
                        <label for="check3"
                            >Say "I want to trade my PS4" - tradein tool</label
                        >
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check4" />
                        <label for="check4"
                            >Say "I need help" - email tool</label
                        >
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check5" />
                        <label for="check5"
                            >Check dashboard logs show conversation</label
                        >
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
            import {
                Room,
                RoomEvent,
                Track,
            } from "https://unpkg.com/livekit-client@2.0.0/dist/livekit-client.esm.mjs";

            let room = null;
            let connected = false;

            window.connect = async function () {
                try {
                    updateStatus("Connecting...", false);
                    addSystemMessage("Requesting connection token...");

                    // Get LiveKit token from backend
                    const response = await fetch(
                        "http://localhost:3000/api/livekit/token",
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                roomName: "test-room-" + Date.now(),
                                participantName: "Test-User-" + Date.now(),
                            }),
                        },
                    );

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || "Failed to get token");
                    }

                    const { token, url } = await response.json();
                    addSystemMessage(
                        "Token received, connecting to LiveKit...",
                    );

                    // Connect to LiveKit room
                    room = new Room();

                    await room.connect(url, token);

                    updateStatus("Connected! Waiting for agent...", true);
                    addSystemMessage(
                        "Connected to room. Agent should join shortly...",
                    );

                    document.getElementById("connectBtn").disabled = true;
                    document.getElementById("disconnectBtn").disabled = false;
                    connected = true;

                    // Listen for participants joining
                    room.on(RoomEvent.ParticipantConnected, (participant) => {
                        addSystemMessage(
                            `Participant joined: ${participant.identity}`,
                        );

                        if (
                            participant.identity.includes("amara") ||
                            participant.identity.includes("agent")
                        ) {
                            updateStatus(
                                "ü§ñ Agent joined! You can speak now.",
                                true,
                            );
                            addSystemMessage(
                                "üéôÔ∏è Agent is ready! Start speaking...",
                            );
                        }
                    });

                    // Listen for audio tracks
                    room.on(
                        RoomEvent.TrackSubscribed,
                        (track, publication, participant) => {
                            if (track.kind === Track.Kind.Audio) {
                                addSystemMessage(
                                    `üîä Receiving audio from ${participant.identity}`,
                                );

                                // Play agent audio
                                const audioElement = track.attach();
                                document.body.appendChild(audioElement);
                                audioElement.play();
                            }
                        },
                    );

                    // Listen for data messages (transcripts, tool calls)
                    room.on(RoomEvent.DataReceived, (payload, participant) => {
                        try {
                            const text = new TextDecoder().decode(payload);
                            const data = JSON.parse(text);

                            console.log("Data received:", data);

                            if (data.type === "transcript") {
                                if (data.role === "user") {
                                    addMessage("user", data.text);
                                } else {
                                    addMessage("agent", data.text);
                                }
                            }

                            if (data.type === "tool_call") {
                                addSystemMessage(
                                    `üîß Tool called: ${data.tool} with args: ${JSON.stringify(data.args)}`,
                                );
                            }
                        } catch (e) {
                            console.log("Non-JSON data received:", payload);
                        }
                    });

                    // Enable microphone
                    await room.localParticipant.setMicrophoneEnabled(true);
                    addSystemMessage(
                        "üé§ Microphone enabled. You can speak now!",
                    );
                } catch (error) {
                    console.error("Connection error:", error);
                    updateStatus("‚ùå Error: " + error.message, false, true);
                    addSystemMessage("‚ùå Connection failed: " + error.message);
                    document.getElementById("connectBtn").disabled = false;
                }
            };

            window.disconnect = async function () {
                if (room) {
                    await room.disconnect();
                    room = null;
                    updateStatus("Disconnected", false);
                    addSystemMessage("Disconnected from voice call");
                    document.getElementById("connectBtn").disabled = false;
                    document.getElementById("disconnectBtn").disabled = true;
                    connected = false;
                }
            };

            function updateStatus(text, isConnected = false, isError = false) {
                const statusEl = document.getElementById("statusText");
                statusEl.textContent = text;
                statusEl.className = "status-text";

                if (isConnected) {
                    statusEl.classList.add("connected");
                } else if (isError) {
                    statusEl.classList.add("error");
                }
            }

            function addMessage(role, text) {
                const transcript = document.getElementById("transcript");

                // Remove empty state
                const emptyState = transcript.querySelector(".empty-state");
                if (emptyState) {
                    emptyState.remove();
                }

                const msg = document.createElement("div");
                msg.className = "message " + role;
                msg.innerHTML = `
        <strong>${role === "user" ? "üë§ You" : "ü§ñ Agent"}</strong>
        <div class="message-text">${text}</div>
      `;
                transcript.appendChild(msg);
                transcript.scrollTop = transcript.scrollHeight;
            }

            function addSystemMessage(text) {
                const transcript = document.getElementById("transcript");

                // Remove empty state
                const emptyState = transcript.querySelector(".empty-state");
                if (emptyState) {
                    emptyState.remove();
                }

                const msg = document.createElement("div");
                msg.className = "message system";
                msg.innerHTML = `<div class="message-text">${text}</div>`;
                transcript.appendChild(msg);
                transcript.scrollTop = transcript.scrollHeight;
            }
        </script>
    </body>
</html>
